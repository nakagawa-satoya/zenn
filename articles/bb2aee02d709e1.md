---
title: "Shared Runner , self-Managed Runner é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥å…±æœ‰ã®æ–¹æ³•"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GitLab","GitLabRunner","GitlabCI","cicd"]
published: true
---
GitLab CI ã§ self-Managed Runner ã‚’æ§‹ç¯‰ã—ã¦ã„ãŸã‚‰ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å—ã‘æ¸¡ã—ãŒä¸Šæ‰‹ãå‹•ã‹ãªã‹ã£ãŸã®ã§ã€æ¨¡ç´¢ã—ãŸè©±

## tl;dr
1. Shared,self-Managed é–“ã¯`cache`ã§ã¯ãªã `artifacts`ã‚’ä½¿ãŠã†
2. `artifacts`ã‚’ã‚„ã‚Šã¨ã‚Šã™ã‚‹`job`ã¯å¿…ãšå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã‚ˆã†
3. å—ã‘å–ã‚Šå´ã®jobã¯`dependencies`ã‚’ä½¿ãŠã†ã€‚stageã‚’å¾Œã‚ã«ã—ã¦ã‚‚è‰¯ã„
4. Runner é–“ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Šã®Topicã¯ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«ã¯æ›¸ã„ã¦ãªã•ãã†

## ã‚„ã‚ŠãŸã„ã“ã¨
`Shared Runner` ã§ã€€ãƒ“ãƒ«ãƒ‰ã—ãŸç”Ÿæˆç‰©ã‚’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å—ã‘æ¸¡ã—ã§ `self-Managed Runner`ã«æ¸¡ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„

```mermaid
graph
    subgraph SR[Shared Runner]
        build[ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–]
    end
    subgraph é–‹ç™ºç’°å¢ƒ
        subgraph HR[self-Managed Runner]
            deploy[ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–]
        end
    end
    SR --ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å—ã‘æ¸¡ã—ãŸã„--> HR
```


## èƒŒæ™¯
å…ƒã€…é–‹ç™ºç’°å¢ƒã«ã¯Jenkinsã‚’å…¥ã‚Œã¦ã€ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ã¦ã„ãŸã‚“ã§ã™ãŒ...
1. é–‹ç™ºç’°å¢ƒå´ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ã‚‚ãªã„
2. Node.jsç³»ã®ãƒ“ãƒ«ãƒ‰ã¯å›æ•°ã‚’é‡ã­ã‚‹ã¨ãƒ¡ãƒ¢ãƒªã‚’åœ§è¿«ã—ã¦å®šæœŸçš„ãªå†èµ·å‹•ãŒå¿…è¦

ã£ã¦ã¨ã“ã‚ãŒèª²é¡Œã«ä¸ŠãŒã£ã¦ã„ã¦CIãƒ„ãƒ¼ãƒ«å´ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ã€
GitLab CIã«å¯„ã›ãŸã„ã¨è¨€ã†ã“ã¨ã§ã€
é–‹ç™ºç’°å¢ƒã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« Runner Install ã—ã¦ã€æ—¢ã«çµ„ã‚“ã§ã‚ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«é–‹ç™ºç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ã‚’è¿½åŠ ã—ãŸããªã‚Šã¾ã—ãŸã€‚

## ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹
ã¨è¨€ã†ã‚ã‘ã§ã¨ã‚Šã‚ãˆãšRunnerç™»éŒ²ã—ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹

## Shared Runner ã®CacheãŒå–ã‚Œãªã„


@[tweet](https://twitter.com/xiombatsg/status/1704772267555856835)

```text:config.tomlãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹ã®å®Ÿè¡Œãƒ­ã‚°
Checking cache for caches-feature/ci/change_ci_path-36148020-npm-18-nuxt3_output-non_protected...
No URL provided, cache will not be downloaded from shared cache server. Instead a local version of cache will be extracted. 
```
- Shared Runner ã«ã‚ã£ãŸã€Google Storageã¸ã®ãƒªãƒ³ã‚¯ãŒå–ã‚Œãªã„
```text:Shared Runnerã®å ´åˆ
Checking cache for caches-feature/ci/change_ci_path-36148020-npm-18-nuxt3-non_protected...
Downloading cache from https://storage.googleapis.com/gitlab-com-runners-cache/project/36148020/caches-feature/ci/change_ci_path-36148020-npm-18-nuxt3-non_protected 
Successfully extracted cache
```

ã©ã†ã‚‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’èª¿ã¹ãŸã¨ã“ã‚ self-Managed Runner ã®config.toml ã®è¨­å®šã‚’Shared Runner ã®GCSè¨­å®šã«æƒãˆã‚‹å¿…è¦ãŒã‚ã‚‹æ§˜å­ã€‚

å‚è€ƒï¼š[The [runners.cache.gcs] section](https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section)
```env:config.toml ä¾‹
[runners.cache]
  Type = "gcs"
  Path = "path/to/prefix"
  Shared = false
  [runners.cache.gcs]
    AccessID = "cache-access-account@test-project-123456.iam.gserviceaccount.com"
    PrivateKey = "-----BEGIN PRIVATE KEY-----\nXXXXXX\n-----END PRIVATE KEY-----\n"
    BucketName = "runners-cache"
```

:::message alert
å½“ç„¶ãªãŒã‚‰Shared Runnerã®GCSã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã¯éå…¬é–‹ã®ãŸã‚å–å¾—ã§ãã¾ã›ã‚“
:::

ã¨ã„ã†ã“ã¨ã§å–å¾—ã§ããªã„ã®ã§`cache`æŒ‡å®šã¯ä½¿ãˆãªã„ ã¨ãªã‚‹ã¨ã€ä»–ã®é¸æŠè‚¢ã¯

1. `artifacts`ã‚’ä½¿ã†
2. è‡ªå‰ã§Host ã™ã‚‹

ãã‚‰ã„ã‹ãªã¨æ€ã†ã€‚
S3/R2ãªã©ã«Hostã—ã¦ã‚‚ã„ã„ã‘ã©ã€ã©ã†ã›ãªã‚‰GitLabã§å®Œçµã—ãŸã„ã®ã§ã€`artifacts`ã‚’ä½¿ã†æ–¹å‘ã§è€ƒãˆã‚‹

## APIã§artifactsã‚’å–å¾—ã—ã¦ã¿ã‚‹

ã¾ãšã€[Job Artifacts API](https://docs.gitlab.com/ee/api/job_artifacts.html)ãŒã‚ã‚‹ã®ã§ã€è©¦ã—ã¦ã¿ã‚‹ã€‚

```yaml:sample
artifact_download:
  stage: test
  script:
    - 'curl --location --output artifacts.zip --header "JOB-TOKEN: $CI_JOB_TOKEN" "https://gitlab.example.com/api/v4/projects/1/jobs/42/artifacts"'
```
JOB-TOKENã—ã¦ã‚‚ã‚ã‚Šã€ã“ã‚ŒãŒæ­£å¼ãªæ–¹æ³•ãªã®ã‹ãªï¼Ÿã£ã¦æ€ã„ã¤ã¤ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‚’å¤‰æ•°ã«è½ã¨ã—è¾¼ã‚“ã§ã€

```bash:å®Ÿéš›ã«å©ã„ã¦ã¿ãŸcurlã‚³ãƒãƒ³ãƒ‰
curl --verbose\
     --location\
     --output artifacts.zip\
     --header "JOB-TOKEN: $CI_JOB_TOKEN"\
     "$CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/jobs/$CI_JOB_ID/artifacts"
```

ã“ã‚“ãªæ„Ÿã˜ã§ã€ã‚„ã£ã¦ã¿ã‚‹ã€‚

**ä¸Šæ‰‹ãã„ã‹ãªã„ãƒ»ãƒ»ãƒ»**

ã©ã†ã‚‚ 

**artifactsã‚’ä½œã‚‹Jobã¨å—ã‘å–ã‚‹Jobã§ã€IDãŒåˆ¥ãªã®ã§Job IDã‚’æŒ‡å®šã§ããªã„**

@[tweet](https://twitter.com/xiombatsg/status/1704795546542834122)

:::message alert
APIã¯ Jobã§ã®ä½¿ç”¨ä¾‹ãŒæ›¸ã„ã¦ã‚ã‚‹ã‘ã©ã€Runneré–“ã§ã®ã‚„ã‚Šå–ã‚Šã§ã¯ä½¿ãˆãªã„
:::

ã£ã¦ã“ã¨ã§ä»–ã®æ‰‹ãŒãªã„ã‹ã¡ã‚‡ã£ã¨è€ƒãˆã‚‹

## `ChatGPTå…ˆç”Ÿã«èã„ã¦ã¿ã‚‹`
ChatGPTå…ˆç”Ÿã«ç¢ºèªã—ã¦ã¿ãŸã‚‰ã€ã“ã®æ‰‹æ³•ãŒè‰¯ã•ãã†ã ã£ãŸã®ã§è©¦ã—ã¦ã¿ã‚‹

1. **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•**:
    1. æœ€åˆã®ã‚¸ãƒ§ãƒ–ã§ã€å¿…è¦ãªæƒ…å ±ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
    2. æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§ã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å–å¾—ã—ã€ãã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

   ä¾‹ãˆã°ã€æœ€åˆã®ã‚¸ãƒ§ãƒ–ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:

   ```yaml
   job1:
     script:
       - echo "ã‚¸ãƒ§ãƒ–ID: $CI_JOB_ID" > job_info.txt
     artifacts:
       paths:
         - job_info.txt
   ```

   æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:

   ```yaml
   job2:
     script:
       - cat job_info.txt
     dependencies:
       - job1
   ```
   
:::message
ã©ã†ã‚„ã‚‰ã€`dependencies` ã‚’ä½¿ã†ã®ãŒè‰¯ã•ãã†
:::

å‚è€ƒï¼š[dependencies](https://docs.gitlab.com/ee/ci/yaml/?query=dependencies#dependencies)

> In this example, two jobs have artifacts: build osx and build linux. When test osx is executed, 
the artifacts from build osx are downloaded and extracted in the context of the build.
> 
> The same thing happens for test linux and artifacts from build linux.
> 
> The deploy job downloads artifacts from all previous jobs because of the stage precedence.

1. `dependencies` ã§ `artifacts` ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹jobã‚’æŒ‡å®šã™ã‚‹ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹ã™ã‚‹
2. å¾Œæ®µã®`stage` ã¯ å‰`stage`ã¾ã§ã«ä½œã‚‰ã‚ŒãŸ`artifacts`å…¨ã¦ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹ã™ã‚‹

## `dependencies`ã‚’ä½¿ã£ã¦ã¿ã‚‹
çµè«–ã‹ã‚‰è¨€ã†ã¨ä¸Šæ‰‹ãã„ã£ãŸã€‚

```yaml:å®Ÿéš›ã«ä½¿ã£ãŸCIã‚¹ã‚¯ãƒªãƒ—ãƒˆ
generate:
  stage: build
  needs: [ "prepare" ]
  script:
    - npx nuxt generate
  cache:
    - key: caches-$CI_COMMIT_REF_NAME-$CI_PROJECT_ID-$JS_PKG-$NODE_VER-node_modules
      paths:
        - node_modules
      policy: pull
    - key: caches-$CI_COMMIT_REF_NAME-$CI_PROJECT_ID-$JS_PKG-$NODE_VER-nuxt3
      paths:
        - .nuxt
      policy: pull
  artifacts:
    name: caches-$CI_COMMIT_REF_NAME-$CI_PROJECT_ID-$JS_PKG-$NODE_VER-nuxt3_output
    paths:
      - .output

deploy:instance:dev:
  stage: deploy
  needs: [ "generate"]
  variables:
    GIT_STRATEGY: none
  dependencies:
    - generate
  before_script:
    - rm -rf /var/www/git-vue
    - mkdir /var/www/git-vue
  script:
    - cp -r ./.output /var/www/git-vue/
    - ls -la /var/www/git-vue/
  tags:
    - $CI_DEPLOY_DEV_TAG
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

```
:::message
artifacts:name ã¯ã‚ã¾ã‚Šé–¢ä¿‚ãŒãªã„ã€‚cache:key ã§æŒ‡å®šã—ã¦ã„ãŸåæ®‹ã§ã™ã€‚
:::

### æ‰‹é †
1. `generate` ã‚¸ãƒ§ãƒ–ã§ `.output` ã‚’`artifacts`ã«
2. `dependencies` ã‚’ `generate`ã«è¨­å®šã—ã€artifactsã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

### ãƒ­ã‚°
```text:Jobã®ãƒ­ã‚°
Downloading artifacts for generate (5139095646)...
Downloading artifacts from coordinator... ok        host=cdn.artifacts.gitlab-static.net id=5139095646 responseStatus=200 OK token=64_GGSVJ

Executing "step_script" stage of the job script

$ rm -rf /var/www/git-vue
$ mkdir /var/www/git-vue
$ cp -r ./.output /var/www/git-vue/
$ ls -la /var/www/git-vue/
åˆè¨ˆ 12
drwxrwxr-x  3 www-data www-data 4096  9æœˆ 21 23:40 .
drwxr-xr-x 17 www-data www-data 4096  9æœˆ 21 23:40 ..
drwxr-xr-x  4 www-data www-data 4096  9æœˆ 21 23:40 .output
```
- .outputãŒæ­£ã—ãã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹

## å¾Œèª²é¡Œ
`artifacts`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€`artifacts`ã¯æœ€æ–°ä»¥å¤–ã¯ç ´æ£„ã•ã‚Œã‚‹è¨­å®šã«ãªã£ã¦ã„ãŸã‚Šã€`cache`ã‚ˆã‚Šå°‘ã—ä½¿ã„å‹æ‰‹ãŒæ‚ªã„ã®ã§ã€
é–‹ç™ºæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã‚ˆã†ãªè¨­å®šã‚’æ¨¡ç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãã®è¾ºã‚Šã®é‹ç”¨ã‚‚ç­”ãˆãŒå‡ºãŸã‚‰è¿½è¨˜ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
